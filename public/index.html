<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Gibberish Generator</title>
  <link rel="stylesheet" href="styles.css">
	<script>
    window.global ||= window;
  </script>
	<script src="dist/version.js"></script>
	<script src="dist/gibberish.js"></script>
</head>
<body style="font-family: sans-serif">
  <label for="sample">Reference</label><br>
  <select id="sample" onchange="updateSampleChoice()">
    <option value="alice.txt">[EN] Alice's Adventures in Wonderland by Lewis Carroll</option>
    <option value="frankenstein.txt">[EN] Frankenstein by Mary Shelley</option>
    <option value="moby-dick.txt">[EN] Moby Dick by Herman Melville</option>
    <option value="20k-leagues.txt">[EN] Twenty Thousands Leagues under the Sea by Jules Verne</option>
    <option value="quixote.txt">[ES] Don Quixote by Miguel de Cervantes</option>
    <option value="monte-cristo.txt">[FR] Le Comte de Monte-Cristo by Alexandre Dumas</option>
    <option value="dante.txt">[IT] La Divina Commedia by Dante Alighieri</option>
    <option value="gaul.txt">[LA] Commentarii de Bello Gallico by Julius Caesar</option>
    <option value="rur.txt">[CZ] Rossum's Universal Robots by Karel Čapek</option>
    <option value="trial.txt">[DE] The Trial by Franza Kafka</option>
    <option value="pan-tadeusz.txt">[PL] Pan Tadeusz by Adam Mickiewicz</option>
    <option value="kalevala.txt">[FI] Kalevala by Elias Lönnrot</option>
    <option value="vintermyren.txt">[SV] Vintermyren by Astrid Väring</option>
    <option value="">Custom</option>
  </select>
  <div id="sample-custom-area" hidden="true">
    <br>
    <textarea id="sample-custom" rows="20" cols="80" maxlength="-1"></textarea>
  </div>
  <br><br>
  <label for="accuracy">Accuracy</label>
  <br>
  <input id="accuracy" pattern="[0-9]+" maxlength="2" value="4"></input>
	<button id="btnLoad" onclick="load()">Load</button>
	<br><br>
  <div id="info-msg"></div><br>
  <div id="post-load" hidden="true">
    <label for="length">Length</label>
    <br>
    <input id="length" pattern="[0-9]+" maxlength="-1" value="500"></input>
    <button id="btnGenerate" onclick="generate()">Generate!</button>
    <br><br>
    <span id="output"></span>
  </div>
  <div class="footer"><a id="footer" href="http://github.com/lawfulstupid/gibberish"></a></div>
</body>
<script>
  document.getElementById('footer').innerHTML = APP_VERSION;

  let generator = null;

  function load() {
    document.getElementById('btnLoad').disabled = true;
    document.getElementById('post-load').hidden = true;
    document.getElementById('output').innerHTML = '';
    const infoMsg = document.getElementById('info-msg');
    infoMsg.hidden = false;
    infoMsg.innerHTML = 'Loading...';

    getSample().then(sample => {
      const accuracy = document.getElementById('accuracy').value;
      generator = createGenerator(sample, accuracy);
      document.getElementById('post-load').hidden = false;
      const mapInfo = global.mapInfo;
      infoMsg.innerHTML = `Dictionary size: ${mapInfo.inputSize}<br>Mean branching factor: ${(mapInfo.outputSize/mapInfo.inputSize).toFixed(2)}`;
    })
    .catch(err => {
      infoMsg.innerHTML = 'Error: ' + err;
    })
    .finally(() => {
      document.getElementById('btnLoad').disabled = false;
    });
  }

  function generate() {
    const btnGenerate = document.getElementById('btnGenerate');
    btnGenerate.disabled = true;
    const length = document.getElementById('length').value;
    const elmOutput = document.getElementById('output');
    try {
      elmOutput.innerHTML = generator(length);
    } catch (err) {
      console.error(err);
      elmOutput.innerHTML = err.message;
    } finally {
      btnGenerate.disabled = false;
    }
  }

  function updateSampleChoice() {
    const sample = document.getElementById('sample').value;
    const customSampleField = document.getElementById('sample-custom-area');
    if (!sample) {
      customSampleField.hidden = false;
    } else {
      customSampleField.hidden = true;
    }
  }

  function getSample() {
    return new Promise((resolve, reject) => {
      const sampleFile = document.getElementById('sample').value;
      if (!sampleFile) {
        resolve(document.getElementById('sample-custom').value);
      } else {
        const xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
          if (xmlhttp.readyState === 4) {
            if (xmlhttp.status === 200) {
              resolve(xmlhttp.responseText);
            } else {
              reject(xmlhttp.statusText);
            }
          }
        }
        xmlhttp.open('GET', 'samples/' + sampleFile, true);
        xmlhttp.send();
      }
    });
  }

  document.getElementById('sample-custom').addEventListener('keypress', event => {
    if (event.key === 'Enter') load();
  });
  document.getElementById('accuracy').addEventListener('keypress', event => {
    if (event.key === 'Enter') load();
  });
  document.getElementById('length').addEventListener('keypress', event => {
    if (event.key === 'Enter') generate();
  });
</script>
</html>
